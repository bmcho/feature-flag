plugins{
    id 'application'
    id 'com.google.cloud.tools.jib' version '3.4.5'
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation project(':feature-flag-usecase')
    implementation project(':feature-flag-adapter')


    //swagger
    implementation 'io.swagger.core.v3:swagger-annotations:_'
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:_'

//    // monitoring
//    implementation 'org.springframework.boot:spring-boot-starter-actuator:_'
//    implementation 'io.micrometer:micrometer-registry-prometheus:_'
}

tasks.bootRun {
    systemProperty 'spring.profiles.active', 'local'
    mainClass = 'com.bmcho.featureflagapp.FeatureFlagAppApplication'
}

tasks.named('test', Test) {
    useJUnitPlatform()
}

jib {
    setMainClassName('com.bmcho.featureflagapp.FeatureFlagApplication')
    from {
        image = "amazoncorretto:17"
        platforms {
            platform {
                architecture = 'amd64'
                os = 'linux'
            }
        }
    }
    to {
        image = "${project.name}".toLowerCase()+ ":${project.version}"
    }
    container {
        ports = ['8080']
        jvmFlags = [
                "-server",
                "-Xms4g",
                "-Xmx4g",
                "-Dspring.profiles.active=local",
                "-XX:+UseContainerSupport",
                "-XX:InitialRAMPercentage=60.0",
                "-XX:MaxRAMPercentage=60.0",
                "-XX:+UseZGC",
                "-XX:+DisableExplicitGC",
                "-XX:MetaspaceSize=256M",
                "-XX:MaxMetaspaceSize=256M",
                "-Duser.timezone=UTC",
                "-Djava.net.preferIPv4Stack=true",
                "-Djava.net.preferIPv6Addresses=false",
                "-Dnetworkaddress.cache.ttl=0",
                "-Dnetworkaddress.cache.negative.ttl=0",
        ]
    }
}
